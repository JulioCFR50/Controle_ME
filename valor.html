<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta Avançada de Invoices</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0 0 20px 0; /* adiciona 20px de espaço abaixo */
    height: 100%;
    overflow: hidden; 
    font-family: Arial, sans-serif;
    background-color: #f0f0f0;
    background-image: url('exportacao.png');
    background-size: cover; 
    background-repeat: no-repeat;
    background-position: center center;
    text-align: center;
}

/* Ajuste do container para respeitar a margem inferior */
.container { 
    display: flex; 
    gap: 20px; 
    justify-content: center;
    align-items: flex-start;
    height: calc(100vh - 200px); /* subtraímos 20px a mais para a margem */
    margin-top: 0px;
    padding-bottom: 100px; /* adiciona margem visual abaixo */
}

/* Painel lateral fixo */
#painel { 
    padding: 15px; 
    min-width: 300px; 
    max-width: 300px; 
    height: 50%;  
    overflow: hidden;
    text-align: left;
    position: sticky; 
    top: 0;
    background: rgba(255,255,255,0.60); 
    border: 1px solid #ccc;
    margin-top: 0px;
}

/* Container da tabela com rolagem vertical apenas no tbody */
#tabelaContainer { 
    flex: 1;
    height: 100%;
    overflow-y: auto; /* permite rolagem vertical no corpo */
    overflow-x: auto; /* rolagem horizontal se necessário */
    background: rgba(255,255,255,0.85); 
    border: 1px solid #ccc;
}

#tabelaCompleta {
    border-collapse: collapse; 
    width: 100%; 
    text-align: center;
}

/* Cabeçalho fixo */
#tabelaCompleta thead th {
    position: sticky;
    top: 0;
    background-color: #007bff; /* azul do cabeçalho */
    color: white;
    z-index: 2;
    padding: 5px 10px;
    border: 1px solid #ccc;
}

/* Corpo da tabela rolando */
#tabelaCompleta tbody td { 
    border: 1px solid #ccc; 
    padding: 5px 10px; 
    text-align: center; 
    cursor: pointer; 
}

#tabelaCompleta tbody tr.selected { 
    background: #cce5ff; 
}

input { 
    padding: 5px 10px; 
    width: 300px; 
    margin-bottom: 10px; 
    text-align: center; 
}

#totais { 
    margin-top: 10px; 
    font-weight: bold; 
    color: blue; 
    text-align: center; 
}

#botoes { 
    margin: 10px 0; 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
    justify-content: center; 
}

button {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 6px 12px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s ease;
}

button:hover {
    background-color: #0056b3;
}

/* Topo fixo opcional */
#topoFixo {
    position: sticky;
    top: 0;
    background: rgba(240,240,240,0.60);
    padding: 10px;
    z-index: 1000;
    text-align: center;
}

</style>
</head>
<body>

<!-- Cabeçalho fixo -->
<div id="topoFixo">
  <h1>Consulta Interativa de Invoices</h1>

  <div id="botoes">
      <button id="btnVoltar" onclick="window.location.href='lista.html'">⬅ Voltar para Lista</button>
      <button id="btnSelecionarTudo">Selecionar Tudo</button>
      <button id="btnLimparSelecao">Limpar Seleção</button>
      <button id="btnExportExcel">Exportar Selecionadas para Excel</button>
  </div>

  <label for="inputInvoice">Pesquisar Invoice(s) (vírgula ou espaço):</label><br>
  <input type="text" id="inputInvoice" placeholder="Ex: 120-2025,123-2025" />
</div>


<div class="container">
    <div id="painel">
        <div id="infoInvoice" style="font-weight:bold; color:green;">
            Informe uma ou mais Invoices para ver os valores.
        </div>
        <div id="totais"></div>
    </div>

    <div id="tabelaContainer">
        <table id="tabelaCompleta">
            <thead>
                <tr>
                    <th>Invoice1</th>
                    <th>Pedido Interno</th>
                    <th>Total US$</th>
                    <th>Total R$</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
let planilhaInvoices = [];
let selecionadas = new Set();

function valorParaNumero(str){
    if(!str) return 0;
    return parseFloat(str.replace(/[^\d,.-]/g,"").replace(/\./g,"").replace(",",".")) || 0;
}

async function carregarPlanilhaGoogle(){
    const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS2BPlrSJmH8T_lSmT6NfmK9brKuvghm4pL6qboEHyPpN0ZXFkIP-kfZkaXtjtqxdsDP9WgFi3gAOrv/pub?output=csv&gid=935980411";
    const response = await fetch(urlCSV);
    const csvText = await response.text();

    const linhas = csvText.split("\n").map(linha => {
        const regex = /(?:\"([^\"]*)\"|([^,]+))/g;
        const resultados = [];
        let match;
        while((match = regex.exec(linha)) !== null){
            resultados.push((match[1] ?? match[2] ?? "").trim());
        }
        return resultados;
    });

    const cabecalho = linhas[0].map(c => c.trim());
    planilhaInvoices = linhas.slice(1).map(linha => {
        let obj = {};
        cabecalho.forEach((c,i) => obj[c] = linha[i]?.trim());
        return obj;
    });

    atualizarTabelaCompleta();
}

carregarPlanilhaGoogle();

const inputInvoice = document.getElementById("inputInvoice");
const infoInvoice = document.getElementById("infoInvoice");
const tbody = document.querySelector("#tabelaCompleta tbody");
const divTotais = document.getElementById("totais");
const btnSelecionarTudo = document.getElementById("btnSelecionarTudo");
const btnLimparSelecao = document.getElementById("btnLimparSelecao");
const btnExportExcel = document.getElementById("btnExportExcel");

function atualizarTabelaCompleta(){
    tbody.innerHTML = "";
    let totalUSD = 0;
    let totalBRL = 0;

    const resultados = selecionadas.size === 0 
        ? planilhaInvoices 
        : planilhaInvoices.filter(i => selecionadas.has(i['Invoice1']));

    resultados.forEach(i => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${i['Invoice1']}</td>
            <td>${i['Pedido Interno']}</td>
            <td>${i['Total US$']}</td>
            <td>${i['Total R$']}</td>
        `;
        if(selecionadas.has(i['Invoice1'])) tr.classList.add("selected");
        tbody.appendChild(tr);

        totalUSD += valorParaNumero(i['Total US$']);
        totalBRL += valorParaNumero(i['Total R$']);

        tr.addEventListener("click", ()=>{
            if(selecionadas.has(i['Invoice1'])){
                selecionadas.delete(i['Invoice1']);
            } else {
                selecionadas.add(i['Invoice1']);
            }
            atualizarTabelaCompleta();
        });
    });

    const qtdSelecionadas = selecionadas.size;
    const qtdTotal = planilhaInvoices.length;

    divTotais.innerHTML = `Total USD: $${totalUSD.toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2})} <br>
                           Total BRL: R$${totalBRL.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2})}`;

    infoInvoice.innerHTML = `Selecionadas: ${qtdSelecionadas} <br>
                             Total de Invoices: ${qtdTotal}`;
}

btnSelecionarTudo.addEventListener("click", ()=>{
    planilhaInvoices.forEach(i => selecionadas.add(i['Invoice1']));
    atualizarTabelaCompleta();
});

btnLimparSelecao.addEventListener("click", ()=>{
    selecionadas.clear();
    inputInvoice.value = "";
    atualizarTabelaCompleta();
});

btnExportExcel.addEventListener("click", ()=>{
    if(selecionadas.size === 0){
        alert("Selecione pelo menos uma Invoice para exportar.");
        return;
    }
    const wb = XLSX.utils.book_new();
    const ws_data = [];
    const cabecalho = ["Invoice1","Pedido Interno","Total US$","Total R$"];
    ws_data.push(cabecalho);

    planilhaInvoices.forEach(i => {
        if(selecionadas.has(i['Invoice1'])){
            ws_data.push([i['Invoice1'], i['Pedido Interno'], i['Total US$'], i['Total R$']]);
        }
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Invoices Selecionadas");
    XLSX.writeFile(wb,"Invoices_Selecionadas.xlsx");
});

inputInvoice.addEventListener("input", ()=>{
    const texto = inputInvoice.value.trim();
    if(texto){
        const filtros = texto.split(/[, ]+/).map(f => f.trim()).filter(f => f.length > 0);
        filtros.forEach(f => {
            if(planilhaInvoices.some(i => i['Invoice1'] === f)){
                selecionadas.add(f);
            }
        });
    }
    atualizarTabelaCompleta();
});
</script>

</body>
</html>
