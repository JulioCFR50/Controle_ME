<!DOCTYPE html>
<html lang="pt-br">
   <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <meta name="description" content="Pagina Relatorio Mercado Externo">
      <meta name="author" content="Julio Cesar">
      <title>Lista de Invoices</title>
      <!-- Biblioteca SheetJS -->
      <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
      <style>
         * { margin:0; padding:0; box-sizing:border-box; }
         body {
         font-family: Arial, sans-serif;
         background: url("exportacao.png") no-repeat center center/cover;
         padding: 10px;
         min-height: 90vh;
         line-height: 1.2;
         color: #333;
         }
         h1 {
         text-align: center;
         margin-bottom: 10px;
         font-size: 1.2rem;
         color: #fff;
         text-shadow: 1px 1px 3px #000;
         position: sticky;
         top: 0;
         background: rgba(0,0,0,0.3);
         z-index:5;
         padding:6px 0;
         border-radius:6px;
         }
         .filtro-container {
         display:flex;
         flex-wrap:wrap;
         justify-content:flex-start;
         gap:6px;
         margin-bottom:10px;
         align-items:center;
         }
         .filtro-container input {
         padding:4px 6px;
         font-size:10px;
         border:1px solid #ccc;
         border-radius:5px;
         width:160px;
         }
         .btn-voltar,
         .btn-limpar,
         .btn-excel {
         display:inline-block;
         margin:0;
         background:#007bff;
         color:white;
         padding:3px 6px;
         border:none;
         border-radius:5px;
         cursor:pointer;
         font-size:10px;
         transition:background 0.3s ease;
         white-space:nowrap;
         }
         .btn-voltar:hover,
         .btn-limpar:hover,
         .btn-excel:hover { background:#0056b3; }
         .table-container {
         width:100%;
         max-height:85vh;
         overflow-x:auto;
         overflow-y:auto;
         background:rgba(255,255,255,0.95);
         border-radius:6px;
         box-shadow:0px 2px 4px rgba(0,0,0,0.2);
         }
         table {
         width:max-content;
         border-collapse:collapse;
         table-layout:fixed;
         min-width:100%;
         font-size:11px;
         }
         th, td {
         border:1px solid #ccc;
         padding:3px 4px;
         text-align:center;
         font-weight:normal;
         }
         th {
         background:#007bff;
         color:white;
         position:sticky;
         top:0;
         z-index:3;
         font-weight:bold;
         font-size:11px;
         }
         tr:nth-child(even) td { background:rgba(240,240,240,0.85); }
         tr:nth-child(odd) td { background:rgba(255,255,255,0.55); }
         tr:hover td { background:#fdf59f !important; cursor:pointer; }
         td[contenteditable="true"] { background:#fff8dc; outline:none; }
         tr.ativo td { background:orange !important; font-weight:bold; color:#fff; }
         input[type="date"] { font-size:10px; padding:3px; border:1px solid #ccc; border-radius:4px; width:120px; }
         th:nth-child(12), td:nth-child(12) { min-width:100px; }
         th:nth-child(13), td:nth-child(13) { min-width:130px; }
         th:nth-child(14), td:nth-child(14) { min-width:180px; max-width:350px; padding:3px 5px; text-align:left; white-space:nowrap; overflow:hidden; }
         @media (max-width:1024px) {
         h1 { font-size:1.1rem; }
         table, th, td { font-size:10px; padding:2px 3px; }
         .btn-voltar, .btn-limpar, .btn-excel { font-size:9px; padding:2px 5px; }
         }
         @media (max-width:768px) {
         .filtro-container input { width:100%; }
         table { min-width:750px; }
         }
         @media (max-width:480px) {
         h1 { font-size:1rem; }
         th, td { font-size:9px; padding:2px 2px; }
         .filtro-container { flex-direction:column; align-items:stretch; }
         .btn-voltar, .btn-limpar, .btn-excel, .filtro-container input { width:100%; }
         }
      </style>
   </head>
   <body>
      <h1>Lista de Invoices</h1>
      <div class="filtro-container">
         <button class="btn-voltar" onclick="window.location.href='index.html'">‚¨Ö Voltar</button>
         <input type="text" id="filtroInvoice" placeholder="Pesquisar por Invoice" />
         <input type="text" id="filtroPO" placeholder="Pesquisar por PO#" />
         <input type="text" id="filtroFaturamento" placeholder="Pesquisar por DT Faturamento" />
         <input type="text" id="filtroCarregamento" placeholder="Pesquisar por DT Carregamento" />
         <input type="text" id="filtroEmbarque" placeholder="Pesquisar por DT Embarque" />
         <button class="btn-limpar" id="btnLimpar">‚úñ Limpar</button>
         <button class="btn-excel" id="btnExcel">üìÑ Exportar Excel</button>
      </div>
      <div class="table-container">
         <table id="tabela">
            <thead>
               <tr>
                  <th>Invoice</th>
                  <th>PO#</th>
                  <th>DT Faturamento</th>
                  <th>DT Carregamento</th>
                  <th>Dead-Line Draft</th>
                  <!--<th>Dead-line VGM</th>-->
                  <th>Dead-line Carga</th>
                  <th>DT Embarque</th>
                  <th>Status Faturamento</th>
                  <th>Status Booking</th>
                  <th>Instru√ß√£o de Embarque</th>
                  <th>Status Produ√ß√£o</th>
                  <th>Protid√£o do Pedido</th>
                  <th>Observa√ß√µes</th>
               </tr>
            </thead>
            <tbody id="dadosTabela"></tbody>
         </table>
      </div>
      <script type="module">
         import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
         import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
         
         const firebaseConfig = {
         	apiKey: "AIzaSyACGNNnZcHU1yA3Vozek5cD6egRnADDKUI",
         	authDomain: "controle-mercado-externo-9c3e8.firebaseapp.com",
         	projectId: "controle-mercado-externo-9c3e8",
         	storageBucket: "controle-mercado-externo-9c3e8.appspot.com",
         	messagingSenderId: "523084089883",
         	appId: "1:523084089883:web:6b9750c6df679852b346be",
         	measurementId: "G-RCJG4ZWJ9E"
         };
         
         const app = initializeApp(firebaseConfig);
         const db = getFirestore(app);
         
         const registros = [];
         const tabela = document.getElementById("dadosTabela");
         const filtroInvoice = document.getElementById("filtroInvoice");
         const filtroPO = document.getElementById("filtroPO");
         const filtroFaturamento = document.getElementById("filtroFaturamento");
         const filtroCarregamento = document.getElementById("filtroCarregamento");
         const filtroEmbarque = document.getElementById("filtroEmbarque");
         const btnLimpar = document.getElementById("btnLimpar");
         const btnExcel = document.getElementById("btnExcel");
         
         // Exibir dados
         function exibirDados(dados) {
         	tabela.innerHTML = "";
         	if(dados.length === 0){
         		const linha = document.createElement("tr");
         		linha.innerHTML = `<td colspan="14" style="color:gray;font-style:italic;">Nenhuma INVOICE encontrada.</td>`;
         		tabela.appendChild(linha);
         	} else {
         		dados.forEach(r => {
         			const linha = document.createElement("tr");
         			linha.innerHTML = `
         				<td>${r.invoice||""}</td>
         				<td>${r.po||""}</td>
         				<td>${r.dtFaturamento||""}</td>
         				<td>${r.dtCarregamento||""}</td>
         				<td>${r.draft||""}</td>
         				<!-- ${r.vgm||""} REMOVIDO -->
         				<td>${r.carga||""}</td>
         				<td>${r.embarque||""}</td>
         				<td>${r.status||""}</td>
         				<td>${r.booking||""}</td>
         				<td>${r.instrucao||""}</td>
         				<td>${r.producao||""}</td>
         				<td>${r.dtProduto||""}</td>
         				<td>${r.observacoes||""}</td>
         			`;
         			tabela.appendChild(linha);
         		});
         	}
         }
         
         // Carrega dados do Firestore
         async function carregarDadosFirestore(){
         	const querySnapshot = await getDocs(collection(db,"invoices"));
         	querySnapshot.forEach(doc => registros.push(doc.data()));
         	exibirDados(registros);
         }
         carregarDadosFirestore();
         
         // Filtros
         function filtrar(){
         	const invoiceFiltro = filtroInvoice.value.toLowerCase();
         	const poFiltro = filtroPO.value.toLowerCase();
         	const faturamentoFiltro = filtroFaturamento.value.toLowerCase();
         	const carregamentoFiltro = filtroCarregamento.value.toLowerCase();
         	const embarqueFiltro = filtroEmbarque.value.toLowerCase();
         	const dadosFiltrados = registros.filter(r =>
         		(r.invoice||"").toLowerCase().includes(invoiceFiltro) &&
         		(r.po||"").toLowerCase().includes(poFiltro) &&
         		(r.dtFaturamento||"").toLowerCase().includes(faturamentoFiltro) &&
         		(r.dtCarregamento||"").toLowerCase().includes(carregamentoFiltro) &&
         		(r.embarque||"").toLowerCase().includes(embarqueFiltro)
         	);
         	exibirDados(dadosFiltrados);
         }
         
         [filtroInvoice,filtroPO,filtroFaturamento,filtroCarregamento,filtroEmbarque].forEach(f => f.addEventListener("input", filtrar));
         
         btnLimpar.addEventListener("click",()=>{
         	filtroInvoice.value="";
         	filtroPO.value="";
         	filtroFaturamento.value="";
         	filtroCarregamento.value="";
         	filtroEmbarque.value="";
         	filtrar();
         	filtroInvoice.focus();
         });
         
         // Exportar Excel (linhas filtradas)
         btnExcel.addEventListener("click", ()=>{
         	const tabelaFiltrada = document.getElementById("tabela");
         	const wb = XLSX.utils.book_new();
         	const ws_data = [];
         
         	// Cabe√ßalho
         	const cabecalho = [];
         	tabelaFiltrada.querySelectorAll("thead th").forEach(th => cabecalho.push(th.innerText.toUpperCase())); // mai√∫sculas
         	ws_data.push(cabecalho);
         
         	// Linhas vis√≠veis
         	tabelaFiltrada.querySelectorAll("tbody tr").forEach(tr => {
         		if(tr.style.display === "none") return;
         		const linha = [];
         		tr.querySelectorAll("td").forEach(td => linha.push(td.innerText));
         		ws_data.push(linha);
         	});
         
         	const ws = XLSX.utils.aoa_to_sheet(ws_data);
         	XLSX.utils.book_append_sheet(wb, ws, "Invoices");
         	XLSX.writeFile(wb,"Lista_Invoices_Filtrada.xlsx");
         });
      </script>
   </body>
</html>